# -*- sh -*-
############################################################
# <bsn.cl fy=2013 v=onl>
# 
#        Copyright 2013, 2014 Big Switch Networks, Inc.       
# 
# Licensed under the Eclipse Public License, Version 1.0 (the
# "License"); you may not use this file except in compliance
# with the License. You may obtain a copy of the License at
# 
#        http://www.eclipse.org/legal/epl-v10.html
# 
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
# either express or implied. See the License for the specific
# language governing permissions and limitations under the
# License.
# 
# </bsn.cl>
############################################################
#
# powerpc-quanta-ly2r-r0
#
############################################################

echo "soc.0/ffe24000.ethernet ma1" >/etc/onl_net
echo "kernel-85xx" >/etc/onl_kernel
echo "initrd-powerpc" >/etc/onl_initrd
echo "rootfs-powerpc" >/etc/onl_rootfs
echo "" >/etc/onl_crashkernel

echo "block/mmcblk0 mmcblk0p2 flash" > /etc/onl_mounts
echo "block/mmcblk0 mmcblk0p3 flash2" >> /etc/onl_mounts

cp /dev/null /etc/fw_env.config
echo "# MTD device name       Device offset   Env. size       Flash sector size" >> /etc/fw_env.config
echo "/dev/mtd2               0x00000000      0x00002000         0x00020000" >> /etc/fw_env.config

# replace fancontrol with specified platform
ln -sf /lib/platform-config/`cat /etc/onl_platform`/sbin/fancontrol `which fancontrol`

# Initialize platform mounts
initmounts

waitforblockdev /mnt/flash
sleep 1 # wait for external block devices to be mounted

test -f /mnt/flash/rc.boot || {
	cat > /mnt/flash/rc.boot <<EOF
# link platform /etc/init.d to root
for f in \`ls /lib/platform-config/powerpc-quanta-ly2r-r0/etc/init.d/*\`; do
	echo \$f
	ln -sf \$f /etc/init.d/\$(basename \$f)
	/usr/sbin/update-rc.d $(basename \$f) defaults
done

# start fanled monitoring
service fanled start

EOF
}
